{% from 'utils/_dataframe.html' import render_dataframe %}
{% from 'utils/_strain_link.html' import render_strain_link %}

{% macro render_results_list(studies, search, offset) %}
  {% if studies|length == 0: %}
    <p class="help">
      Couldn't find a study with these parameters.
    </p>
  {% endif %}

  {% for study in studies: %}
    <li>
      <div class="search-study">
        <h3 class="flex-row flex-gap-10">
          <a href="{{ url_for('study_show_page', publicId=study.publicId) }}">
            {{ study.nameWithId|highlight(search.query_words) }}
          </a>

          <div class="flex-row flex-right flex-gap-10">
            {% if not study.isPublished: %}
              <span
                  class="icon icon-invisible flex-end"
                  data-tooltip="This study is not published yet. You're seeing it because you uploaded it, you have permission to manage it, or you're an admin.">
              </span>
            {% endif %}

            {% if study.manageable_by_user(g.current_user): %}
              <span
                  class="icon icon-tool flex-end"
                  data-tooltip="You are able to manage this study, either because you uploaded it or because you've given someone the right to edit it.">
              </span>
            {% endif %}
          </div>
        </h3>

        {% if study.description: %}
          {{ study.description|highlight(search.query_words)|format_text(first_paragraph=True, p_class="small") }}
        {% endif %}

        <p>
          <strong>Project ID</strong>:
          <a href="{{ url_for('project_show_page', publicId=study.project.publicId) }}">
            {{ study.project.publicId }}
          </a>
        </p>

        {% if study.studyURL and study.studyURL != '': %}
          <p>
            <strong>Publication URL</strong>:
            {{ study.studyURL|external_link() }}
          </p>
        {% endif %}

        <table class="simple-table margin-top-10 small">
          <tr>
            <th>Techniques</th>
            <th>Strains</th>
            <th>Metabolites</th>
          </tr>

          <tr>
            <td>
              <ul>
                {% for technique_name in study.studyTechniques|map(attribute="short_name_with_subject_type")|unique: %}
                  <li>{{ technique_name }}</li>
                {% endfor %}
              </ul>
            </td>

            <td>
              <ul>
                {% for strain in study.strains if strain.notUnknown: %}
                  <li class="{{ 'highlight' if strain.ncbiId in search.ncbiIds else '' }}">
                    {{ render_strain_link(strain) }}
                  </li>
                {% endfor %}
              </ul>
            </td>

            <td>
              <ul>
                {% for metabolite in study.metabolites: %}
                  <li class="{{ 'highlight' if metabolite.chebiId in search.chebiIds else '' }}">
                    <a href="{{ url_for('metabolite_show_page', chebiId=metabolite.chebiId) }}">
                      {{ metabolite.name }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
        </table>
      </div>
    </li>
  {% endfor %}
{% endmacro %}
