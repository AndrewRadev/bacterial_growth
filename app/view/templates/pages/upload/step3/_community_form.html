{% macro render_community_form(data, index) %}
  {% if index is none: %}
    {% set prefix = '' %}
  {% else: %}
    {% set prefix = 'techniques-{}-'.format(index)  %}
  {% endif %}

  <div
      class="subform-container box technique-container js-subform-container"
      data-index="{{ index if index is not none else '' }}"
      data-subject-type="bioreplicate">
    <img
        width="80"
        class="form-icon"
        alt="Community-level measurement"
        src="/static/images/large-icons/test-tube.png" />
    <h3>
      <span class="js-index">{{ index + 1 if index is not none else '' }}</span>.
      Community-level measurement
    </h3>

    <input type="hidden" name="{{ prefix }}subjectType" value="bioreplicate" />

    <div class="form-row">
      <label class="full">
        <div>Type of measurement technique</div>
        <select
            name="{{ prefix }}type"
            class="form-input-full form-input-blue js-type-select js-preview-trigger" />
          <option value="fc" data-column-name="FC counts" {{ "selected" if data['type'] == 'fc' }}>
            Flow Cytometry
          </option>
          <option value="od" data-column-name="OD" {{ "selected" if data['type'] == 'od' }}>
            Optical Density (absorbance)
          </option>
          <option value="plates" data-column-name="plate counts" {{ "selected" if data['type'] == 'plates' }}>
            Plate Counts
          </option>
          <option value="qpcr" data-column-name="qPCR counts" {{ "selected" if data['type'] == 'qpcr' }}>
            qPCR
          </option>
          <option value="ph" data-column-name="pH" {{ "selected" if data['type'] == 'ph' }}>
            pH
          </option>
        </select>
      </label>

      <label class="full" data-tooltip="If you have multiple kinds of measurements with the same technique, e.g. Flow Cytometry quantified in two different ways, you can specify a short label to differentiate them">
        <span>Optional label:</span>
        <input
            type="text"
            name="{{ prefix }}label"
            class="form-input-full form-input-blue js-label js-preview-trigger"
            value="{{ data['label'] if data }}" />
      </label>

      <label class="full">
        <span>Units:</span>
        <select
            name="{{ prefix }}units"
            class="form-input-full form-input-blue js-unit-select js-preview-trigger" />
          <optgroup label="Cells per volume">
            <option value="Cells/mL" {{ "selected" if data['units'] == 'Cells/mL' }}>
              Cells/mL
            </option>
            <option value="Cells/μL" {{ "selected" if data['units'] == 'Cells/μL' }}>
              Cells/μL
            </option>
          </optgroup>

          <optgroup label="CFUs per volume">
            <option value="CFUs/mL" {{ "selected" if data['units'] == 'CFUs/mL' }}>
              CFUs/mL
            </option>
            <option value="CFUs/μL" {{ "selected" if data['units'] == 'CFUs/μL' }}>
              CFUs/μL
            </option>
          </optgroup>

          <optgroup label="Biomass concentration">
            <option value="g/L" {{ "selected" if data['units'] == 'g/L' }}>
              g/L
            </option>
          </optgroup>

          <optgroup label="Unitless/unknown">
            <option value="" {{ "selected" if data['units'] == '' }}>
              N/A
            </option>
          </optgroup>
        </select>
      </label>
    </div>

    <div class="form-row">
      <div class="flex-column flex-gap-6 flex-1">
        <div class="flex-column flex-gap-6" data-tooltip="If you're not sure whether your measurements include only live cells or count all cells, you can leave the checkboxes blank. Ideally, we recommend marking the relevant types.">
          <span class="input-label">Types of cells counted:</span>
          <label>
            <input
                type="checkbox"
                class="js-include-live js-preview-trigger"
                name="{{ prefix }}includeLive"
                {{ "checked" if not data or data['includeLive'] }} />
            Live cells
          </label>

          <label>
            <input
                type="checkbox"
                class="js-include-dead js-preview-trigger"
                name="{{ prefix }}includeDead"
                {{ "checked" if not data or data['includeDead'] }} />
            Dead cells
          </label>

          <label>
            <input
                type="checkbox"
                class="js-include-total js-preview-trigger"
                name="{{ prefix }}includeTotal"
                {{ "checked" if not data or data['includeTotal'] }} />
            Total cells (live + dead)
          </label>
        </div>

        <div class="flex-column flex-gap-6">
          <span class="input-label">Extra measurements:</span>

          <label
              data-tooltip="If you have multiple technical replicates, you can submit your point estimate as the measurement and add the standard deviation in a separate column.">
            <input
                type="checkbox"
                class="js-include-std js-preview-trigger"
                name="{{ prefix }}includeStd"
                {{ "checked" if data and data['includeStd'] }} />
            Include STD
          </label>
        </div>
      </div>

      <label class="flex-column flex-2">
        <div>Description of methodology</div>
        <textarea
            name="{{ prefix }}description"
            class="form-input-full form-input-blue"
            placeholder="Example: We used a <brand name> flow cytometer with CYBR Green I staining..."
            rows=4>{{ data['description'] if data }}</textarea>
      </label>
    </div>

    <hr>

    <div class="form-row">
      <div style="overflow-x: auto">
        Data spreadsheet preview:

        <table class="dataframe-table margin-top-10">
          <tr class="js-preview-header">
          </tr>
          <tr class="js-preview-body">
          </tr>
        </table>
      </div>

      <div class="no-label flex-right">
        <a href="#" class="white-button flex-row js-remove-trigger">
          <span class="icon icon-remove"></span> Remove
        </a>
      </div>
    </div>
  </div>
{% endmacro %}
