{% from 'utils/_post_button.html' import post_button %}

{% extends '_layout.html' %}

{% block title %}: Manage study {{ study.studyId }}{% endblock %}

{% block content %}
  <div class="container study-page" data-study-id="{{ study.studyId }}">
    {% include 'pages/studies/_header.html' %}

    <article>
      <h1>{{ study.studyName }}</h1>

      {% include 'pages/studies/_navigation_buttons.html' %}

      <h2>Private Unique Identifier</h2>

      <p>
        This private ID can be used to gain access to the study for
        editing purposes. Only share it with other users that need that
        access.
      </p>

      <p>
        <div class="copy-button-wrapper flex-row flex-grow">
          <button type="button" class="js-copy-button copy-button green-button">
            Copy ðŸ“‹
          </button>
          <input
              type="text"
              value="{{ study.uuid }}"
              class="js-export-url export-url form-input-blue full"
              readonly />
        </div>
      </p>

      <h2>Edit study</h2>

      <p>
        To re-upload the data or apply changes to the experimental design, you
        need to go through the submission process again
        (<a href="{{ url_for('upload_status_page') }}">Upload data</a>)
        and choose to update this study.
      </p>

      {% set lastSubmission = study.find_last_submission(g.db_session) %}

      {% if lastSubmission: %}
        <p>
          You can also edit the latest submission that updated this study by
          clicking on this button:
        </p>

        <p>
          {{ post_button("Edit submission", url_for('edit_submission_action', id=lastSubmission.id)) }}
        </p>
      {% endif %}

      <h2>Models and other calculations</h2>

      <p>
        Select a type of calculation to perform on the study's measurements.
        The results will be available for visualization once the calculation is
        finished.
      </p>

      <br>

      <form
          action="{{ url_for('study_calculations_action', studyId=study.publicId) }}"
          class="simple-form js-calculation-form"
          method="POST">
        <div class="flex-row flex-gap-10">
          <div class="column full">
            <div class="form-row">
              <label>
                <span>Calculation type</span>
                <br>
                <select class="form-input-blue">
                  <option name="type" value="baranyi_roberts">Baranyi-Roberts model</option>
                </select>
              </label>
            </div>

            <div class="form-row">
              <label>
                <span>Measurement technique</span>
                <br>
                <select class="form-input-blue js-technique-type">
                  {% for technique in study.measurementTechniques if technique.is_growth: %}
                    <option name="measurementTechniqueId" value="{{ technique.id }}">
                      {{ technique.long_name }}

                      {% if technique.subjectType != 'metabolite': %}
                        per {{ technique.subject_short_name }}
                      {% endif %}
                    </option>
                  {% endfor %}
                </select>
              </label>
            </div>

            <div class="form-row">
              Measurement subjects:
            </div>

            <div class="form-row">
              {% for technique in study.measurementTechniques if technique.is_growth: %}
                <div class="box hidden" data-technique-id="{{ technique.id }}">
                  {% for subject in technique.get_subjects(g.db_session): %}
                    <label>
                      <input
                          type="checkbox"
                          name="subject|{{ technique.subjectType }}|{{ subject.id }}" />
                      {{ subject.name }}
                    </label>
                    <br>
                  {% endfor %}
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="column full">
            <div class="box">
              Preview
            </div>

            <div>
              <h4>Coefficients</h4>
            </div>
          </div>
        </div>

        <input type="submit" class="flex-end" value="Calculate" />
      </form>
    </article>
  </div>
{% endblock %}
