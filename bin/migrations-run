#! /usr/bin/env python3

import os
import sys
from pathlib import Path
from importlib import import_module

import sqlalchemy as sql

from db import get_connection
from lib.migrate import run

def main():
    migration_dir = os.path.abspath(f"{os.path.dirname(__file__)}/../db/migrations")
    migration_files = Path(migration_dir).glob('*.py')
    migration_names = {path.stem for path in migration_files}

    direction = sys.argv[1] if len(sys.argv) > 1 else "up"
    if direction not in ('up', 'down'):
        print("Invalid migration direction: {direction}. Expected 'up' or 'down'")
        sys.exit(1)

    with get_connection() as conn:
        # Bootstrap first migration
        conn.execute(sql.text("""
            CREATE TABLE IF NOT EXISTS MigrationVersions (
                id         BIGINT AUTO_INCREMENT,
                name       VARCHAR(255),
                migratedAt DATETIME DEFAULT CURRENT_TIMESTAMP,

                PRIMARY KEY (id)
            );
        """))
        conn.commit()

        query = "SELECT name FROM MigrationVersions WHERE migratedAt IS NOT NULL"
        applied_migrations = {name for (name,) in conn.execute(sql.text(query)).all()}
        pending_migrations = migration_names - applied_migrations

        if direction == 'up':
            if len(pending_migrations) == 0:
                print("Database up-to-date, nothing to do")
                return

            for name in sorted(pending_migrations):
                migration_module = import_module(f"db.migrations.{name}")
                run(migration_module.__file__, migration_module.up, migration_module.down, direction="up")
        else:
            if len(applied_migrations) == 0:
                print("No applied migrations to roll back")
                return

            latest_migration = max(applied_migrations)
            migration_module = import_module(f"db.migrations.{latest_migration}")
            run(migration_module.__file__, migration_module.up, migration_module.down, direction="down")



if __name__ == "__main__":
    main()
